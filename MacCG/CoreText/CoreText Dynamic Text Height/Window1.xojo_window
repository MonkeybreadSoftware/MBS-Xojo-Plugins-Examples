#tag Window
Begin Window Window1
   BackColor       =   &cFFFFFF00
   Backdrop        =   0
   CloseButton     =   True
   Composite       =   False
   Frame           =   0
   FullScreen      =   False
   FullScreenButton=   False
   HasBackColor    =   False
   Height          =   526
   ImplicitInstance=   False
   LiveResize      =   "True"
   MacProcID       =   0
   MaxHeight       =   32000
   MaximizeButton  =   False
   MaxWidth        =   32000
   MenuBar         =   1437882407
   MenuBarVisible  =   True
   MinHeight       =   64
   MinimizeButton  =   False
   MinWidth        =   64
   Placement       =   0
   Resizeable      =   False
   Title           =   "CoreText Dynamic Text Height"
   Visible         =   True
   Width           =   574
   Begin Canvas Canvas1
      AcceptFocus     =   False
      AcceptTabs      =   False
      AutoDeactivate  =   True
      Backdrop        =   0
      DoubleBuffer    =   False
      Enabled         =   True
      EraseBackground =   "True"
      Height          =   50
      HelpTag         =   ""
      Index           =   -2147483648
      InitialParent   =   ""
      Left            =   300
      LockBottom      =   False
      LockedInPosition=   False
      LockLeft        =   True
      LockRight       =   True
      LockTop         =   True
      Scope           =   "0"
      TabIndex        =   0
      TabPanelIndex   =   0
      TabStop         =   True
      Top             =   0
      Transparent     =   True
      UseFocusRing    =   True
      Visible         =   True
      Width           =   274
   End
   Begin Timer Timer1
      Enabled         =   True
      Index           =   -2147483648
      InitialParent   =   ""
      LockedInPosition=   False
      Mode            =   2
      Period          =   1000
      Scope           =   "0"
      TabPanelIndex   =   "0"
   End
   Begin Canvas Canvas2
      AcceptFocus     =   False
      AcceptTabs      =   False
      AutoDeactivate  =   True
      Backdrop        =   0
      DoubleBuffer    =   False
      Enabled         =   True
      EraseBackground =   "True"
      Height          =   477
      HelpTag         =   ""
      Index           =   -2147483648
      InitialParent   =   ""
      Left            =   300
      LockBottom      =   True
      LockedInPosition=   False
      LockLeft        =   True
      LockRight       =   True
      LockTop         =   True
      Scope           =   "0"
      TabIndex        =   1
      TabPanelIndex   =   0
      TabStop         =   True
      Top             =   49
      Transparent     =   True
      UseFocusRing    =   True
      Visible         =   True
      Width           =   274
   End
   Begin TextArea TextArea1
      AcceptTabs      =   False
      Alignment       =   0
      AutoDeactivate  =   True
      AutomaticallyCheckSpelling=   True
      BackColor       =   &cFFFFFF00
      Bold            =   False
      Border          =   True
      DataField       =   ""
      DataSource      =   ""
      Enabled         =   True
      Format          =   ""
      Height          =   65
      HelpTag         =   ""
      HideSelection   =   True
      Index           =   -2147483648
      Italic          =   False
      Left            =   7
      LimitText       =   0
      LineHeight      =   0.0
      LineSpacing     =   0.0
      LockBottom      =   False
      LockedInPosition=   False
      LockLeft        =   True
      LockRight       =   False
      LockTop         =   True
      Mask            =   ""
      Multiline       =   True
      ReadOnly        =   False
      Scope           =   "0"
      ScrollbarHorizontal=   False
      ScrollbarVertical=   True
      Styled          =   True
      TabIndex        =   2
      TabPanelIndex   =   0
      TabStop         =   True
      Text            =   "Nam liber tempor cum soluta nobis eleifend option congue nihil imperdiet doming id quod mazim placerat facer END"
      TextColor       =   
      TextFont        =   "System"
      TextSize        =   0.0
      TextUnit        =   0
      Top             =   7
      Transparent     =   True
      Underline       =   False
      UnicodeMode     =   0
      UseFocusRing    =   True
      Visible         =   True
      Width           =   293
   End
   Begin Slider Slider1
      AutoDeactivate  =   True
      Enabled         =   True
      Height          =   23
      HelpTag         =   ""
      Index           =   -2147483648
      InitialParent   =   ""
      Left            =   65
      LineStep        =   1
      LiveScroll      =   True
      LockBottom      =   False
      LockedInPosition=   False
      LockLeft        =   True
      LockRight       =   False
      LockTop         =   True
      Maximum         =   50
      Minimum         =   15
      PageStep        =   20
      Scope           =   "0"
      TabIndex        =   3
      TabPanelIndex   =   0
      TabStop         =   True
      TickStyle       =   0
      Top             =   84
      Transparent     =   True
      Value           =   35
      Visible         =   True
      Width           =   189
   End
   Begin Label Label1
      AutoDeactivate  =   True
      Bold            =   False
      DataField       =   ""
      DataSource      =   ""
      Enabled         =   True
      Height          =   20
      HelpTag         =   ""
      Index           =   -2147483648
      InitialParent   =   ""
      Italic          =   False
      Left            =   7
      LockBottom      =   False
      LockedInPosition=   False
      LockLeft        =   True
      LockRight       =   False
      LockTop         =   True
      Multiline       =   False
      Scope           =   "0"
      Selectable      =   False
      TabIndex        =   4
      TabPanelIndex   =   0
      TabStop         =   True
      Text            =   "Font Size"
      TextAlign       =   0
      TextColor       =   
      TextFont        =   "System"
      TextSize        =   10.0
      TextUnit        =   0
      Top             =   84
      Transparent     =   False
      Underline       =   False
      Visible         =   True
      Width           =   53
   End
   Begin Label Label2
      AutoDeactivate  =   True
      Bold            =   False
      DataField       =   ""
      DataSource      =   ""
      Enabled         =   True
      Height          =   20
      HelpTag         =   ""
      Index           =   -2147483648
      InitialParent   =   ""
      Italic          =   False
      Left            =   264
      LockBottom      =   False
      LockedInPosition=   False
      LockLeft        =   True
      LockRight       =   False
      LockTop         =   True
      Multiline       =   False
      Scope           =   "0"
      Selectable      =   False
      TabIndex        =   5
      TabPanelIndex   =   0
      TabStop         =   True
      Text            =   "35"
      TextAlign       =   0
      TextColor       =   
      TextFont        =   "System"
      TextSize        =   10.0
      TextUnit        =   0
      Top             =   84
      Transparent     =   False
      Underline       =   False
      Visible         =   True
      Width           =   24
   End
End
#tag EndWindow

#tag WindowCode
	#tag Note, Name = About
		
		Thanks to Mark Franken from Sounds In Sync for creating this example project.
		
		Shows how to correctly caluclate the text height.
		
	#tag EndNote


#tag EndWindowCode

#tag Events Canvas1
	#tag Event
		Sub Paint(g As Graphics, areas() As REALbasic.Rect)
		  
		  // create a font, quasi systemFontWithSize:24.0
		  dim sysUIFont as CTFontMBS = CTFontMBS.CreateUIFontForLanguage(CTFontMBS.kCTFontUIFontSystem, 18.0)
		  
		  // create a naked string
		  dim text as string = "Edit Text and change Font size."
		  
		  // blue
		  dim cgColor as CGColorMBS = CGColorMBS.CreateGenericRGB(0.0, 0.0, 1.0)
		  
		  // single underline
		  dim underline as integer = CoreTextMBS.kCTUnderlineStyleSingle
		  
		  // pack it into attributes dictionary
		  dim attributesDict as new Dictionary
		  attributesDict.Value(CoreTextMBS.kCTFontAttributeName) = sysUIFont
		  attributesDict.Value(CoreTextMBS.kCTForegroundColorAttributeName) = cgColor
		  attributesDict.Value(CoreTextMBS.kCTUnderlineStyleAttributeName) = underline
		  
		  // make the attributed string
		  dim cfDic as new CFDictionaryMBS(attributesDict)
		  dim cfStr as new CFStringMBS(text)
		  dim stringToDraw as CFAttributedStringMBS = CFAttributedStringMBS.Create( cfStr, cfDic)
		  
		  // now for the actual drawing
		  
		  dim CGContextHandle as integer = g.Handle(g.HandleTypeCGContextRef)
		  dim CGContext as CGContextMBS = CGContextMBS.contextWithCGContext(CGContextHandle)
		  
		  CGContext.SaveGState
		  
		  // reset text matrix
		  dim a as CGAffineTransformMBS = CGAffineTransformMBS.Identity
		  CGContext.TextMatrix = a
		  
		  // draw
		  dim line as CTLineMBS = CTLineMBS.CreateWithAttributedString(stringToDraw)
		  
		  dim x as integer = 10
		  dim y as integer = 10
		  
		  // plus text height
		  y = y + 24
		  
		  // swap y 
		  y = g.Height - y  
		  
		  CGContext.TextPosition = new CGPointMBS(x, y)
		  line.Draw(CGContext)
		  
		  CGContext.RestoreGState
		  CGContext.Flush
		  
		  // clean up
		  
		End Sub
	#tag EndEvent
#tag EndEvents
#tag Events Timer1
	#tag Event
		Sub Action()
		  Canvas1.Invalidate
		End Sub
	#tag EndEvent
#tag EndEvents
#tag Events Canvas2
	#tag Event
		Sub Paint(g As Graphics, areas() As REALbasic.Rect)
		  
		  dim longText as string = TextArea1.Text
		  
		  dim s as new NSMutableAttributedStringMBS
		  call s.initWithString(longText)
		  
		  Dim FontSize As Integer = Slider1.Value
		  
		  // setup font
		  dim helvetica as CTFontMBS = CTFontMBS.CreateWithName("Helvetica", FontSize)
		  
		  dim r1 as new NSRangeMBS(0, s.Length)
		  s.addattribute(CoreTextMBS.kCTFontAttributeName, helvetica, r1)
		  
		  // add some color
		  dim greenColor  as CGColorMBS = CGColorMBS.CreateGenericRGB(0.19, 0.56, 0.20)
		  s.addattribute(CoreTextMBS.kCTForegroundColorAttributeName, greenColor, r1)
		  
		  // add color red to last three characters
		  if s.Length > 2 then
		    dim redColor  as CGColorMBS = CGColorMBS.CreateGenericRGB(1, 0, 0)
		    dim r2 as new NSRangeMBS(s.Length - 3, 3)
		    s.addattribute(CoreTextMBS.kCTForegroundColorAttributeName, redColor, r2)
		  end if
		  
		  // centre text
		  dim p as NSParagraphStyleMBS = NSParagraphStyleMBS.defaultParagraphStyle
		  dim p2 As NSMutableParagraphStyleMBS = p.mutableCopy
		  p2.setAlignment NSParagraphStyleMBS.NSCenterTextAlignment
		  s.addattribute(CoreTextMBS.kCTParagraphStyleAttributeName, p2, r1)
		  
		  // layout master
		  dim cs as CFAttributedStringMBS = s.AsCFAttributedString
		  dim framesetter as CTFramesetterMBS = CTFramesetterMBS.CreateWithAttributedString(cs)
		  
		  // calculate height required to display all text
		  dim sizeOfWidth As CGSizeMBS = CGSizeMBS.Make(g.Width, 10000)    // How do I set 'CGFloat_Max' instead of 10000?   [Question]
		  
		  dim fitRangeLocation, fitRangeLength As Integer
		  dim dEmpty As New Dictionary
		  dim sizeOfFrame As CGSizeMBS = framesetter.SuggestFrameSizeWithConstraints(0, 0, dEmpty, sizeOfWidth, fitRangeLocation, fitRangeLength)
		  
		  
		  // Resize height of window to fit all of text
		  dim NewWinHeight As Integer = sizeOfFrame.Height + me.Top
		  self.Height = NewWinHeight
		  
		  // create form
		  dim ColumnPath as new CGMutablePathMBS
		  dim Rect as new CGRectMBS(0, 0, g.Width, g.Height)
		  ColumnPath.AddRect nil, Rect
		  
		  // create frame
		  dim Frame as CTFrameMBS = framesetter.CreateFrame(0, 0, ColumnPath, nil)
		  
		  // get context
		  dim CGContextHandle as integer = g.Handle(g.HandleTypeCGContextRef)
		  dim CGContext as CGContextMBS = CGContextMBS.contextWithCGContext(CGContextHandle)
		  
		  CGContext.SaveGState
		  // reset text matrix
		  dim a as CGAffineTransformMBS = CGAffineTransformMBS.Identity
		  CGContext.TextMatrix = a
		  
		  // draw frame
		  Frame.Draw(CGContext)
		  
		  // cleanup
		  CGContext.RestoreGState
		  CGContext.Flush
		  
		  
		End Sub
	#tag EndEvent
#tag EndEvents
#tag Events TextArea1
	#tag Event
		Sub TextChange()
		  Canvas2.Invalidate
		  
		End Sub
	#tag EndEvent
#tag EndEvents
#tag Events Slider1
	#tag Event
		Sub ValueChanged()
		  
		  Label2.Text = Str(me.value)
		  Canvas2.Invalidate
		  
		End Sub
	#tag EndEvent
#tag EndEvents
#tag ViewBehavior
	#tag ViewProperty
		Name="MinimumWidth"
		Visible=true
		Group="Size"
		InitialValue="64"
		Type="Integer"
		EditorType=""
	#tag EndViewProperty
	#tag ViewProperty
		Name="MinimumHeight"
		Visible=true
		Group="Size"
		InitialValue="64"
		Type="Integer"
		EditorType=""
	#tag EndViewProperty
	#tag ViewProperty
		Name="MaximumWidth"
		Visible=true
		Group="Size"
		InitialValue="32000"
		Type="Integer"
		EditorType=""
	#tag EndViewProperty
	#tag ViewProperty
		Name="MaximumHeight"
		Visible=true
		Group="Size"
		InitialValue="32000"
		Type="Integer"
		EditorType=""
	#tag EndViewProperty
	#tag ViewProperty
		Name="Type"
		Visible=true
		Group="Frame"
		InitialValue="0"
		Type="Types"
		EditorType="Enum"
		#tag EnumValues
			"0 - Document"
			"1 - Movable Modal"
			"2 - Modal Dialog"
			"3 - Floating Window"
			"4 - Plain Box"
			"5 - Shadowed Box"
			"6 - Rounded Window"
			"7 - Global Floating Window"
			"8 - Sheet Window"
			"9 - Metal Window"
			"11 - Modeless Dialog"
		#tag EndEnumValues
	#tag EndViewProperty
	#tag ViewProperty
		Name="HasCloseButton"
		Visible=true
		Group="Frame"
		InitialValue="True"
		Type="Boolean"
		EditorType=""
	#tag EndViewProperty
	#tag ViewProperty
		Name="HasMaximizeButton"
		Visible=true
		Group="Frame"
		InitialValue="True"
		Type="Boolean"
		EditorType=""
	#tag EndViewProperty
	#tag ViewProperty
		Name="HasMinimizeButton"
		Visible=true
		Group="Frame"
		InitialValue="True"
		Type="Boolean"
		EditorType=""
	#tag EndViewProperty
	#tag ViewProperty
		Name="HasFullScreenButton"
		Visible=true
		Group="Frame"
		InitialValue="False"
		Type="Boolean"
		EditorType=""
	#tag EndViewProperty
	#tag ViewProperty
		Name="DefaultLocation"
		Visible=true
		Group="Behavior"
		InitialValue="0"
		Type="Locations"
		EditorType="Enum"
		#tag EnumValues
			"0 - Default"
			"1 - Parent Window"
			"2 - Main Screen"
			"3 - Parent Window Screen"
			"4 - Stagger"
		#tag EndEnumValues
	#tag EndViewProperty
	#tag ViewProperty
		Name="HasBackgroundColor"
		Visible=true
		Group="Background"
		InitialValue="False"
		Type="Boolean"
		EditorType=""
	#tag EndViewProperty
	#tag ViewProperty
		Name="BackgroundColor"
		Visible=true
		Group="Background"
		InitialValue="&hFFFFFF"
		Type="Color"
		EditorType="Color"
	#tag EndViewProperty
	#tag ViewProperty
		Name="Name"
		Visible=true
		Group="ID"
		InitialValue=""
		Type="String"
		EditorType=""
	#tag EndViewProperty
	#tag ViewProperty
		Name="Interfaces"
		Visible=true
		Group="ID"
		InitialValue=""
		Type="String"
		EditorType=""
	#tag EndViewProperty
	#tag ViewProperty
		Name="Super"
		Visible=true
		Group="ID"
		InitialValue=""
		Type="String"
		EditorType=""
	#tag EndViewProperty
	#tag ViewProperty
		Name="Width"
		Visible=true
		Group="Position"
		InitialValue="600"
		Type="Integer"
		EditorType=""
	#tag EndViewProperty
	#tag ViewProperty
		Name="Height"
		Visible=true
		Group="Position"
		InitialValue="400"
		Type="Integer"
		EditorType=""
	#tag EndViewProperty
	#tag ViewProperty
		Name="Composite"
		Visible=true
		Group="Appearance"
		InitialValue="False"
		Type="Boolean"
		EditorType=""
	#tag EndViewProperty
	#tag ViewProperty
		Name="Backdrop"
		Visible=true
		Group="Appearance"
		InitialValue=""
		Type="Picture"
		EditorType=""
	#tag EndViewProperty
	#tag ViewProperty
		Name="Title"
		Visible=true
		Group="Appearance"
		InitialValue="Untitled"
		Type="String"
		EditorType=""
	#tag EndViewProperty
	#tag ViewProperty
		Name="Visible"
		Visible=true
		Group="Appearance"
		InitialValue="True"
		Type="Boolean"
		EditorType=""
	#tag EndViewProperty
	#tag ViewProperty
		Name="FullScreen"
		Visible=true
		Group="Appearance"
		InitialValue="False"
		Type="Boolean"
		EditorType=""
	#tag EndViewProperty
	#tag ViewProperty
		Name="MenuBarVisible"
		Visible=true
		Group="Appearance"
		InitialValue="True"
		Type="Boolean"
		EditorType=""
	#tag EndViewProperty
	#tag ViewProperty
		Name="Resizeable"
		Visible=true
		Group="Appearance"
		InitialValue="True"
		Type="Boolean"
		EditorType=""
	#tag EndViewProperty
	#tag ViewProperty
		Name="MacProcID"
		Visible=true
		Group="Appearance"
		InitialValue="0"
		Type="Integer"
		EditorType=""
	#tag EndViewProperty
	#tag ViewProperty
		Name="MenuBar"
		Visible=true
		Group="Appearance"
		InitialValue=""
		Type="MenuBar"
		EditorType=""
	#tag EndViewProperty
	#tag ViewProperty
		Name="ImplicitInstance"
		Visible=true
		Group="Appearance"
		InitialValue="True"
		Type="Boolean"
		EditorType=""
	#tag EndViewProperty
#tag EndViewBehavior
